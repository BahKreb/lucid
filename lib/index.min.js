const e=new class{constructor(){this.components={},this.id=0,this.work=[]}state(e,t){const o=this.currentComponent;o.__hooks[o.__hookId]=o.__hooks[o.__hookId]||e;const r=o.__hookId;return[o.__hooks[o.__hookId++],(e,n)=>{const d=o.__hooks[r];return o.__hooks[r]=e,n||t&&t(d,e)||o.update(),e}]}effect(e,t){var o;const r=this.currentComponent;if(!r.__dom)return void this.work.push({cb:()=>{this.effect(e,t)},hookId:r.__hookId++});const n=r.__hooks[r.__hookId],d=!(null==n?void 0:n.deps)||!t.every(((e,t)=>e===n.deps[t]));t&&!d||("function"==typeof(null===(o=r.__hooks[r.__hookId])||void 0===o?void 0:o.cleanup)&&r.__hooks[r.__hookId].cleanup(),r.__hooks[r.__hookId]={},r.__hooks[r.__hookId].deps=t,r.__hooks[r.__hookId].cleanup=e()),++r.__hookId}ref(){return this.state({dom:void 0})[0]}createElement(e,t,...o){return{tag:e,attrs:t,children:o}}render(e,t){if("function"==typeof e.tag){const o={attrs:e.attrs,update:()=>{if("function"==typeof e.tag){const t=this.currentComponent;this.currentComponent=o,o.__hookId=0;const r=e.tag(o);this._update(o.__dom,r,o.__element,o),o.__element=r,this.currentComponent=t}},__dom:void 0,__element:void 0,__children:[],__hooks:[],__hookId:0},r=this.currentComponent;this.currentComponent=o;const n=this.id++;return this.components[n]=o,this._render(t,o.__element=e.tag(o),o,{svg:!1,parent:!0}),this.processWork(),this.currentComponent=r,n}}_render(e,t,o,r){if(Array.isArray(t)){for(let n=0;n<t.length;++n)"function"==typeof t[n].tag?o.__children.push(this.render(t[n],e)):this._render(e,t[n],o,r);return}let n;"svg"===t.tag||r.svg?(n=document.createElementNS("http://www.w3.org/2000/svg",t.tag),r.svg=!0):n=document.createElement(t.tag),r.parent&&(o.__dom=n,r.parent=!1);for(let e in t.attrs)e.startsWith("on")?n.addEventListener(e.substring(2).toLowerCase(),t.attrs[e],{capture:!0}):this.setDomAttribute(n,e,t.attrs[e]);for(let e=0;e<t.children.length;++e)"function"==typeof t.children[e].tag?o.__children.push(this.render(t.children[e],n)):"object"==typeof t.children[e]?this._render(n,t.children[e],o,r):n.appendChild(document.createTextNode(t.children[e]));e.appendChild(n)}_update(e,t,o,r){var n,d;if(e.tagName.toLowerCase()!==t.tag){const o=e.parentNode;null==o||o.removeChild(e),e=document.createElement(t.tag),null==o||o.appendChild(e)}for(let t in null==o?void 0:o.attrs)t.startsWith("on")?o.attrs&&o.attrs[t]&&e.removeEventListener(t.substring(2).toLowerCase(),o.attrs[t],{capture:!0}):this.removeDomAttribute(e,t);for(let o in null==t?void 0:t.attrs)o.startsWith("on")?t.attrs&&t.attrs[o]&&e.addEventListener(o.substring(2).toLowerCase(),t.attrs[o],{capture:!0}):this.setDomAttribute(e,o,t.attrs[o]);for(let s=0;s<t.children.length||s<e.childNodes.length;++s)if(void 0!==t.children[s])if("function"==typeof t.children[s].tag){const o=document.createElement("div");r.__children.push(this.render(t.children[s],o)),void 0===e.childNodes[s]?e.appendChild(o.firstChild):e.insertBefore(o.firstChild,e.childNodes[s])}else{if(Array.isArray(t.children[s])){const i=o.children[s],h=t.children[s];let c={};for(let t=0;t<i.length;++t)c[i[t].attrs.key]=e.childNodes[t];for(let t=0,o=0;t<i.length||o<h.length;)if((null===(n=i[t])||void 0===n?void 0:n.attrs.key)===(null===(d=h[o])||void 0===d?void 0:d.attrs.key))++t,++o;else if(i[t]&&h[o]){let n=c[i[t].attrs.key];const d=document.createElement("div");"function"==typeof h[o].tag?r.__children.push(this.render(h[o],d)):this._render(d,h[o],r,{svg:!1,parent:!1}),e.insertBefore(d.firstChild,n),++o}else if(!i[t]&&h[o]){const t=document.createElement("div");"function"==typeof h[o].tag?r.__children.push(this.render(h[o],t)):this._render(t,h[o],r,{svg:!1,parent:!1}),e.appendChild(t.firstChild),++o}else i[t]&&!h[o]?(e.removeChild(c[i[t].attrs.key]),++t,++o):(++t,++o);break}"object"==typeof t.children[s]?(void 0===e.childNodes[s]?e.appendChild(document.createElement(t.children[s].tag)):e.childNodes[s].nodeType!==document.ELEMENT_NODE&&e.insertBefore(document.createElement(t.children[s].tag),e.childNodes[s]),this._update(e.childNodes[s],t.children[s],o.children[s],r)):void 0===e.childNodes[s]?e.appendChild(document.createTextNode(t.children[s])):e.childNodes[s].nodeType!==document.TEXT_NODE?e.insertBefore(document.createTextNode(t.children[s]),e.childNodes[s]):e.childNodes[s].nodeValue!==t.children[s]&&(e.childNodes[s].nodeValue=t.children[s])}else e.removeChild(e.childNodes[s--]);for(let e=0;e<r.__children.length;++e)this.components[r.__children[e]].__dom.parentNode||(delete this.components[r.__children[e]],r.__children.splice(e--,1))}setDomAttribute(e,t,o){switch(t){case"key":case"":break;case"ref":o.dom=e;break;default:e.setAttribute(t,o)}}removeDomAttribute(e,t){switch(t){case"key":case"ref":case"":break;default:e.removeAttribute(t)}}processWork(){for(let e=0;e<this.work.length;++e)this.currentComponent.__hookId=this.work[e].hookId,this.work[e].cb();this.work=[]}};export{e as soda};
