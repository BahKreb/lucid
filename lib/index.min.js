const e=new class{constructor(){this.components={},this.id=0,this.work=[]}state(e,t){const o=this.currentComponent;o.__hooks[o.__hookId]=o.__hooks[o.__hookId]||e;const r=o.__hookId;return[o.__hooks[o.__hookId++],(e,n)=>{const s=o.__hooks[r];return o.__hooks[r]=e,n||t&&t(s,e)||o.update(),e}]}effect(e,t){var o;const r=this.currentComponent;if(!r.__dom)return void this.work.push({cb:()=>{this.effect(e,t)},hookId:r.__hookId++});const n=r.__hooks[r.__hookId],s=!(null==n?void 0:n.deps)||!t.every(((e,t)=>e===n.deps[t]));t&&!s||("function"==typeof(null===(o=r.__hooks[r.__hookId])||void 0===o?void 0:o.cleanup)&&r.__hooks[r.__hookId].cleanup(),r.__hooks[r.__hookId]={},r.__hooks[r.__hookId].deps=t,r.__hooks[r.__hookId].cleanup=e()),++r.__hookId}ref(){return this.state({dom:void 0})[0]}createElement(e,t,...o){return{tag:e,attrs:t,children:o}}render(e,t){if("function"==typeof e.tag){const o={attrs:e.attrs,update:()=>{if("function"==typeof e.tag){const t=this.currentComponent;this.currentComponent=o,o.__hookId=0;const r=e.tag(o);this._update(o.__dom,r,o.__element,o),o.__element=r,this.currentComponent=t}},__dom:void 0,__element:void 0,__children:[],__hooks:[],__hookId:0},r=this.currentComponent;this.currentComponent=o;const n=this.id++;return this.components[n]=o,this._render(t,o.__element=e.tag(o),o,{svg:!1,parent:!0}),this.processWork(),this.currentComponent=r,n}}_render(e,t,o,r){if(Array.isArray(t)){for(let n=0;n<t.length;++n)"function"==typeof t[n].tag?o.__children.push(this.render(t[n],e)):this._render(e,t[n],o,r);return}let n;"svg"===t.tag||r.svg?(n=document.createElementNS("http://www.w3.org/2000/svg",t.tag),r.svg=!0):n=document.createElement(t.tag),r.parent&&(o.__dom=n,r.parent=!1);for(let e in t.attrs)e.startsWith("on")?n.addEventListener(e.substring(2).toLowerCase(),t.attrs[e],{capture:!0}):this.setDomAttribute(n,e,t.attrs[e],void 0);for(let e=0;e<t.children.length;++e)"function"==typeof t.children[e].tag?o.__children.push(this.render(t.children[e],n)):"object"==typeof t.children[e]?this._render(n,t.children[e],o,r):n.appendChild(document.createTextNode(t.children[e]));e.appendChild(n)}_update(e,t,o,r){var n,s;if(e.tagName.toLowerCase()!==t.tag){const o=e.parentNode;null==o||o.removeChild(e),e=document.createElement(t.tag),null==o||o.appendChild(e)}const i={};for(let r in null==o?void 0:o.attrs)r.startsWith("on")?(o.attrs&&o.attrs[r]&&e.removeEventListener(r.substring(2).toLowerCase(),o.attrs[r],{capture:!0}),t.attrs&&t.attrs[r]&&(i[r]=!0,e.addEventListener(r.substring(2).toLowerCase(),t.attrs[r],{capture:!0}))):(null==t?void 0:t.attrs[r])?(i[r]=!0,this.setDomAttribute(e,r,t.attrs[r],o.attrs[r])):this.removeDomAttribute(e,r);for(let o in null==t?void 0:t.attrs)i[o]||(o.startsWith("on")?t.attrs&&t.attrs[o]&&e.addEventListener(o.substring(2).toLowerCase(),t.attrs[o],{capture:!0}):this.setDomAttribute(e,o,t.attrs[o],void 0));for(let i=0;i<t.children.length||i<e.childNodes.length;++i)if(void 0!==t.children[i])if("function"==typeof t.children[i].tag){const o=document.createElement("div");r.__children.push(this.render(t.children[i],o)),void 0===e.childNodes[i]?e.appendChild(o.firstChild):e.insertBefore(o.firstChild,e.childNodes[i])}else{if(Array.isArray(t.children[i])){const d=o.children[i],h=t.children[i];let c={};for(let t=0;t<d.length;++t)c[d[t].attrs.key]=e.childNodes[t];for(let t=0,o=0;t<d.length||o<h.length;)if((null===(n=d[t])||void 0===n?void 0:n.attrs.key)===(null===(s=h[o])||void 0===s?void 0:s.attrs.key)){if("function"==typeof h[o].tag)this.components[r.__children[t]].attrs=h[o].attrs,this.components[r.__children[t]].update();else{let e=c[d[t].attrs.key];this._update(e,h[o],d[t],r)}++t,++o}else if(d[t]&&h[o]){let n=c[d[t].attrs.key];const s=document.createElement("div");"function"==typeof h[o].tag?r.__children.push(this.render(h[o],s)):this._render(s,h[o],r,{svg:!1,parent:!1}),e.insertBefore(s.firstChild,n),++o}else if(!d[t]&&h[o]){const t=document.createElement("div");"function"==typeof h[o].tag?r.__children.push(this.render(h[o],t)):this._render(t,h[o],r,{svg:!1,parent:!1}),e.appendChild(t.firstChild),++o}else d[t]&&!h[o]?(e.removeChild(c[d[t].attrs.key]),++t,++o):(++t,++o);break}"object"==typeof t.children[i]?(void 0===e.childNodes[i]?e.appendChild(document.createElement(t.children[i].tag)):e.childNodes[i].nodeType!==document.ELEMENT_NODE&&e.insertBefore(document.createElement(t.children[i].tag),e.childNodes[i]),this._update(e.childNodes[i],t.children[i],o.children[i],r)):void 0===e.childNodes[i]?e.appendChild(document.createTextNode(t.children[i])):e.childNodes[i].nodeType!==document.TEXT_NODE?e.insertBefore(document.createTextNode(t.children[i]),e.childNodes[i]):e.childNodes[i].nodeValue!==t.children[i]&&(e.childNodes[i].nodeValue=t.children[i])}else e.removeChild(e.childNodes[i--]);for(let e=0;e<r.__children.length;++e)this.components[r.__children[e]].__dom.parentNode||(delete this.components[r.__children[e]],r.__children.splice(e--,1))}setDomAttribute(e,t,o,r){switch(t){case"key":case"":break;case"ref":o.dom=e;break;case"style":for(const t in o)e.style[t]=o[t];break;default:o!==r&&e.setAttribute(t,o)}}removeDomAttribute(e,t){switch(t){case"key":case"ref":case"":case"style":break;default:e.removeAttribute(t)}}processWork(){for(let e=0;e<this.work.length;++e)this.currentComponent.__hookId=this.work[e].hookId,this.work[e].cb();this.work=[]}};export{e as soda};
